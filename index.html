<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>LLM 博弈 - 实时观战</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #1a1a1a; color: #e0e0e0; margin: 0; padding: 20px; font-size: 14px; }
        h1 { text-align: center; color: #f0f0f0; border-bottom: 2px solid #555; padding-bottom: 10px; }

        #god-panel {
            width: 90%; max-width: 1000px; margin: 0 auto 20px auto;
            background-color: #2c2c2c; border: 1px solid #555; border-radius: 8px;
            padding: 15px; display: flex; flex-direction: column;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }
        .panel-row-1 { display: flex; justify-content: space-around; flex-wrap: wrap; }
        .panel-item { font-size: 1.2em; color: #fff; margin: 5px 15px; text-align: center; }
        .panel-item strong { color: #ffc107; display: block; font-size: 0.8em; margin-bottom: 5px; }
        #panel-players {
            width: 100%; display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;
        }
        .player-chip-info {
            font-size: 1.1em; color: #ddd; text-align: center;
            background: #333; padding: 10px; border-radius: 5px;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
        }
        .player-chip-info strong { color: #2196f3; display: block; font-size: 0.9em; }
        .player-hand { font-size: 1.2em; color: #fff; margin-top: 8px; font-weight: bold; min-height: 1.2em; }
        .player-chip-info.eliminated { text-decoration: line-through; opacity: 0.6; }

        .player-status-indicator {
            position: absolute;
            top: 5px;
            right: 8px;
            font-size: 0.8em;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .status-hidden {
            background-color: #f44336;
            color: white;
        }
        .status-looked {
            background-color: #4caf50;
            color: white;
        }

        .dealer-badge {
            color: #ffc107;
            font-size: 0.9em;
            margin-right: 5px;
        }


        #controls { text-align: center; margin-bottom: 15px; }

        .control-button {
            padding: 10px 20px; font-size: 1.2em;
            color: white; border: none; border-radius: 5px;
            cursor: pointer; transition: background-color 0.3s;
            margin: 0 10px;
        }
        .control-button:hover:not(:disabled) {
            opacity: 0.8;
        }
        .control-button:disabled {
            background-color: #555; color: #999;
            cursor: not-allowed;
        }

        #start-button { background-color: #4caf50; }
        #stop-button { background-color: #f44336; }
        #clear-button { background-color: #03a9f4; }


        #status { text-align: center; color: #ffc107; margin-bottom: 20px; font-size: 1.1em; }

        #log-container {
            width: 90%; max-width: 1000px; margin: 0 auto;
            background-color: #252525; border: 1px solid #444; border-radius: 8px;
            height: 60vh;
            overflow-y: scroll; padding: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }
        .log-message { margin: 0 0 8px 0; padding-bottom: 8px; border-bottom: 1px dashed #444; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; }
        .log-message:last-child { border-bottom: none; }
        .log-message[data-log-type="round-start"] { color: #4caf50; font-weight: bold; font-size: 1.2em; }
        .log-message[data-log-type="turn"] { color: #2196f3; font-weight: bold; }
        .log-message[data-log-type="action"] { color: #ff9800; }
        .log-message[data-log-type="result"] { color: #f44336; font-weight: bold; font-size: 1.2em; }
        .log-message[data-log-type="thinking"] { color: #00bcd4; padding: 10px; background-color: rgba(0, 188, 212, 0.05); border-left: 3px solid #00bcd4; border-bottom: 1px dashed #444; }
    </style>
</head>
<body>
    <h1>LLM 锦标赛 - 实时观战</h1>

    <div id="god-panel">
        <div class="panel-row-1">
            <div class="panel-item"><strong>锦标赛局数</strong><span id="panel-hand-count">0</span></div>
            <div class="panel-item"><strong>当前底池</strong><span id="panel-current-pot">0</span></div>
        </div>
        <div id="panel-players" class="panel-players"></div>
    </div>

    <div id="controls">
        <button id="start-button" class="control-button" disabled>连接中...</button>
        <button id="stop-button" class="control-button" disabled>停止游戏</button>
        <button id="clear-button" class="control-button" disabled>清空日志</button>
    </div>

    <div id="status">正在连接到服务器...</div>
    <div id="log-container"></div>

    <script>
        const statusDiv = document.getElementById("status");
        const logContainer = document.getElementById("log-container");
        const startButton = document.getElementById("start-button");
        const stopButton = document.getElementById("stop-button");
        const clearButton = document.getElementById("clear-button");
        let ws = null;
        let lastLogElement = null;

        function connect() {
            const wsProtocol = window.location.protocol === "https:" ? "wss:" : "ws:";
            const wsUrl = `${wsProtocol}//${window.location.host}/ws`;
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                statusDiv.textContent = "已连接 (上帝模式)";
                statusDiv.style.color = "#4caf50";
                setButtonState(false);
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                const isScrolledToBottom = logContainer.scrollHeight - logContainer.clientHeight <= logContainer.scrollTop + 10;

                if (msg.type === "log") { addLog(msg.message); }
                else if (msg.type === "stream_start") {
                    addLog(msg.message, true);
                    if (lastLogElement) { lastLogElement.dataset.logType = "thinking"; }
                } else if (msg.type === "stream_chunk") {
                    if (lastLogElement) {
                        const cleanChunk = msg.chunk;
                        lastLogElement.textContent += cleanChunk;
                        if (isScrolledToBottom) {
                            logContainer.scrollTop = logContainer.scrollHeight;
                        }
                    }
                } else if (msg.type === "panel_update") {
                    updateGodPanel(msg.data);

                } else if (msg.type === "status") {
                    setButtonState(msg.running);
                }

                if ((msg.type === "log" || msg.type === "stream_start") && isScrolledToBottom) {
                     logContainer.scrollTop = logContainer.scrollHeight;
                }
            };

            ws.onclose = () => {
                statusDiv.textContent = "连接已断开。5秒后重试...";
                statusDiv.style.color = "#f44336";
                setButtonState(false, true);
                setTimeout(connect, 5000);
            };
            ws.onerror = () => {
                statusDiv.textContent = "连接错误。";
                statusDiv.style.color = "#f44336";
                ws.close();
            };
        }

        function setButtonState(isRunning, isConnecting = false) {
            if (isConnecting) {
                startButton.disabled = true;
                stopButton.disabled = true;
                clearButton.disabled = true;
                startButton.textContent = "连接中...";
            } else if (isRunning) {
                startButton.disabled = true;
                stopButton.disabled = false;
                clearButton.disabled = true;
                startButton.textContent = "游戏运行中...";
            } else {
                startButton.disabled = false;
                stopButton.disabled = true;
                clearButton.disabled = false;
                startButton.textContent = "开始游戏";
            }
        }

        startButton.onclick = () => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "START_GAME" }));
            }
        };

        stopButton.onclick = () => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                if (confirm("确定要立即停止当前锦标赛吗？")) {
                    ws.send(JSON.stringify({ type: "STOP_GAME" }));
                }
            }
        };

        clearButton.onclick = () => {
            logContainer.innerHTML = "";
            addLog("--- 日志已清空 ---");
        };

        // (新) updateGodPanel - 已修改
        function updateGodPanel(data) {
            document.getElementById("panel-hand-count").textContent = data.hand_count;
            // --- (关键 BUG 修复) ---
            // 'data.current-pot' (错误) 已改为 'data.current_pot' (正确)
            document.getElementById("panel-current-pot").textContent = data.current_pot;

            const playersDiv = document.getElementById("panel-players");
            playersDiv.innerHTML = "";

            if (data.players) {
                data.players.forEach(player => {
                    const pDiv = document.createElement("div");
                    pDiv.className = "player-chip-info";
                    if (player.chips <= 0) {
                        pDiv.classList.add("eliminated");
                    }

                    let statusIndicator = "";
                    if (player.is_active) {
                        if (player.looked) {
                            statusIndicator = '<div class="player-status-indicator status-looked">已看牌</div>';
                        } else {
                            statusIndicator = '<div class="player-status-indicator status-hidden">未看牌</div>';
                        }
                    }

                    const dealerBadge = player.is_dealer ? '<span class="dealer-badge">(庄)</span>' : '';

                    pDiv.innerHTML = `
                        ${statusIndicator}
                        <strong>${dealerBadge} ${player.name} (P${player.id})</strong>
                        <span>筹码: ${player.chips}</span>
                        <div class="player-hand">${player.hand_str || '...'}</div>
                    `;
                    playersDiv.appendChild(pDiv);
                });
            }
        }

        function addLog(message, isStreaming = false) {
            const p = document.createElement("p");
            p.className = "log-message";
            p.textContent = message;

            if (message.includes("--- 第") && message.includes("手牌开始")) {
                p.dataset.logType = "round-start";
            } else if (message.includes("--- 轮到")) {
                p.dataset.logType = "turn";
            } else if (message.includes(" 动作]:")) {
                p.dataset.logType = "action";
            } else if (message.includes("赢家是") || message.includes("--- 本手结束 ---")) {
                p.dataset.logType = "result";
            }
            logContainer.appendChild(p);

            if (!isStreaming) {
                lastLogElement = null;
            } else {
                lastLogElement = p;
            }
        }

        connect();
    </script>
</body>
</html>
