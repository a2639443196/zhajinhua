<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>LLM åšå¼ˆ - å®æ—¶è§‚æˆ˜</title>
    <style>
        :root {
            color-scheme: dark;
            --bg-color: #0c0d11;
            --card-color: rgba(28, 32, 45, 0.9);
            --accent: #4cafef;
            --accent-strong: #00e5ff;
            --danger: #ff5370;
            --success: #66ffa6;
            --text-primary: #f5f7ff;
            --text-secondary: #b6bfd6;
            --border-color: rgba(255, 255, 255, 0.06);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "PingFang SC", "Helvetica Neue", Arial, sans-serif;
            background: radial-gradient(circle at top, rgba(40, 48, 72, 0.5), var(--bg-color));
            color: var(--text-primary);
            line-height: 1.7;
            -webkit-font-smoothing: antialiased;
            display: flex;
            justify-content: center;
            padding: 36px 24px 48px;
            min-height: 100vh;
        }

        .page {
            width: min(1400px, 100%);
            display: flex;
            flex-direction: column;
            gap: 28px;
        }

        header {
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        header h1 {
            margin: 0;
            font-size: clamp(1.8rem, 3.5vw, 2.4rem);
            font-weight: 700;
            letter-spacing: 0.04em;
        }

        header p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 1.05rem;
        }

        main {
            display: flex;
            flex-direction: column;
            gap: 22px;
        }

        .card {
            background: var(--card-color);
            backdrop-filter: blur(16px);
            border-radius: 22px;
            padding: 24px;
            border: 1px solid var(--border-color);
            box-shadow: 0 18px 36px rgba(0, 0, 0, 0.35);
        }

        .status-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 24px;
            flex-wrap: wrap;
        }

        .status-overview {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .status-label {
            color: var(--text-secondary);
            font-size: 1rem;
            letter-spacing: 0.05em;
        }

        .status-value {
            font-size: 1.35rem;
            font-weight: 600;
            color: var(--accent);
        }

        .controls {
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .control-button {
            appearance: none;
            border: none;
            border-radius: 14px;
            padding: 12px 24px;
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text-primary);
            background: linear-gradient(145deg, rgba(76, 175, 239, 0.9), rgba(0, 149, 218, 0.82));
            box-shadow: 0 10px 22px rgba(0, 0, 0, 0.32);
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.2s ease, opacity 0.2s ease;
        }

        .control-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 14px 26px rgba(0, 0, 0, 0.38);
        }

        .control-button:active:not(:disabled) {
            transform: translateY(0);
        }

        .control-button:disabled {
            opacity: 0.45;
            box-shadow: none;
            cursor: default;
        }

        .control-button.stop {
            background: linear-gradient(145deg, rgba(255, 83, 112, 0.92), rgba(255, 105, 135, 0.84));
        }

        .control-button.clear {
            background: linear-gradient(145deg, rgba(123, 97, 255, 0.92), rgba(166, 95, 255, 0.85));
        }

        .log-box {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
        }

        #god-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h2 {
            margin: 0;
            font-size: 1.35rem;
            font-weight: 600;
        }

        .panel-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 18px;
        }

        .summary-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 16px 18px;
            text-align: center;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.02);
        }

        .summary-item span {
            display: block;
            font-size: 0.85rem;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
        }

        .summary-item strong {
            display: block;
            margin-top: 6px;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .panel-grid {
            display: grid;
            /* ç¼©å°æœ€å°å¡ç‰‡å®½åº¦åˆ° 160pxï¼Œä»¥é€‚åº”æ›´å¤š AI */
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 18px;
        }

        .player-card {
            background: rgba(255, 255, 255, 0.04);
            border-radius: 16px;
            padding: 18px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border: 1px solid transparent;
            position: relative;
            transition: border-color 0.2s ease, transform 0.2s ease;
        }

        .player-card.active {
            border-color: rgba(0, 229, 255, 0.4);
            box-shadow: 0 0 0 1px rgba(0, 229, 255, 0.18);
        }

        .player-card.eliminated {
            opacity: 0.55;
        }

        .player-card.folded .player-hand {
            color: var(--danger);
        }

        .player-name {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .player-name span {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .dealer-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(255, 193, 7, 0.95);
            color: #1a1a1a;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .player-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .player-chips {
            color: var(--accent);
            font-weight: 500;
        }

        .player-tag {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.03em;
            text-transform: uppercase;
        }

        .player-tag.looked {
            background: rgba(102, 255, 166, 0.2);
            color: var(--success);
        }

        .player-tag.hidden {
            background: rgba(255, 83, 112, 0.18);
            color: var(--danger);
        }

        .player-hand {
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: 0.06em;
        }

        .player-experience-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 6px;
            font-size: 0.92rem;
            color: var(--text-secondary);
        }

        .player-experience-text {
            white-space: nowrap;
            font-weight: 500;
            color: var(--text-primary);
        }

        .experience-bar {
            flex: 1;
            height: 6px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.08);
            overflow: hidden;
            position: relative;
        }

        .experience-bar-fill {
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: linear-gradient(90deg, rgba(76, 175, 239, 0.7), rgba(0, 229, 255, 0.9));
        }

        .player-pressure {
            margin-top: 4px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            letter-spacing: 0.04em;
        }

        .log-card {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-secondary);
            font-size: 1rem;
            letter-spacing: 0.05em;
        }

        .log-body {
            display: flex;
            gap: 18px;
            align-items: flex-start;
        }

        .inventory-panel {
            flex: 0 0 220px;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            padding: 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .inventory-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            letter-spacing: 0.08em;
        }

        .inventory-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .inventory-player {
            display: flex;
            flex-direction: column;
            gap: 6px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 10px 12px;
        }

        .inventory-player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .inventory-count {
            font-size: 0.85rem;
            color: var(--accent);
        }

        .inventory-items {
            margin: 0;
            padding-left: 18px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .inventory-item {
            line-height: 1.5;
        }

        .inventory-empty {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        #log-container {
            max-height: 60vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-right: 6px;
            flex: 1 1 0;
        }

        .log-message {
            margin: 0;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border-left: 3px solid transparent;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.7;
            color: var(--text-primary);
        }

        .log-message[data-log-type="round-start"] {
            border-left-color: var(--success);
        }

        .log-message[data-log-type="turn"] {
            border-left-color: var(--accent);
        }

        .log-message[data-log-type="action"] {
            border-left-color: rgba(255, 193, 7, 0.8);
        }

        .log-message[data-log-type="result"] {
            border-left-color: var(--danger);
        }

        .log-message[data-log-type="thinking"] {
            border-left-color: var(--accent-strong);
            background: rgba(0, 229, 255, 0.05);
        }

        .player-card.is-current-turn {
            /* æ˜¾è‘—çš„è¾¹æ¡†é¢œè‰² */
            border-color: var(--accent-strong);
            /* å¢åŠ è¾¹æ¡†å®½åº¦ */
            border-width: 2px;
            /* å‘¼å¸æ•ˆæœæˆ–é«˜äº®é˜´å½± */
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.7);
            /* æ·»åŠ åŠ¨ç”»ï¼Œè®©é«˜äº®æ›´æ˜æ˜¾ */
            animation: pulse-border 1.5s infinite alternate;
        }

        @keyframes pulse-border {
            from {
                border-color: var(--accent);
                box-shadow: 0 0 5px rgba(0, 229, 255, 0.4);
            }
            to {
                border-color: var(--accent-strong);
                box-shadow: 0 0 15px rgba(0, 229, 255, 0.8);
            }
        }

        @media (max-width: 820px) {
            body {
                padding: 24px 16px 36px;
            }

            .card {
                padding: 20px;
            }

            .panel-grid {
                /* åœ¨ç§»åŠ¨ç«¯/å°å±å¹•ä¸Šä¹Ÿå…è®¸æ›´ç´§å‡‘çš„æ˜¾ç¤º */
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }

            .log-body {
                flex-direction: column;
            }

            .inventory-panel {
                width: 100%;
                max-height: none;
            }
        }

        @media (max-width: 520px) {
            .status-card {
                flex-direction: column;
                align-items: flex-start;
            }

            .controls {
                width: 100%;
                justify-content: stretch;
            }

            .controls .control-button {
                flex: 1 1 auto;
                text-align: center;
            }
        }
    </style>
</head>
<body>
<div class="page">
    <header>
        <h1>LLM é”¦æ ‡èµ›Â·ä¸Šå¸è§†è§’</h1>
        <p>æ¡Œé¢ç«¯ç„•æ–°ç•Œé¢ï¼Œå®æ—¶æŒæ¡æ¯ä¸€æ¬¡ç­¹ç æµå‘</p>
    </header>
    <main>
        <section class="card status-card">
            <div class="status-overview">
                <span class="status-label">å½“å‰è¿æ¥çŠ¶æ€</span>
                <span class="status-value" id="status">æ­£åœ¨è¿æ¥åˆ°æœåŠ¡å™¨...</span>
            </div>
            <div class="controls">
                <!-- æ–°å¢ï¼šæ¸¸æˆå‚æ•°è¾“å…¥ -->
                <input id="input-initial-chips" type="number" min="1" step="1" value="2000"
                       title="åˆå§‹ç­¹ç " placeholder="åˆå§‹ç­¹ç " style="padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border-color); background: rgba(255,255,255,0.06); color: var(--text-primary); width: 140px;" />
                <input id="input-desperation-threshold" type="number" min="1" step="1" value="1000"
                       title="ç»å¢ƒé˜ˆå€¼" placeholder="ç»å¢ƒé˜ˆå€¼" style="padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border-color); background: rgba(255,255,255,0.06); color: var(--text-primary); width: 140px;" />
                <button id="start-button" class="control-button" disabled>è¿æ¥ä¸­...</button>
                <button id="stop-button" class="control-button stop" disabled>åœæ­¢æ¸¸æˆ</button>
                <button id="clear-button" class="control-button clear" disabled>æ¸…ç©ºæ—¥å¿—</button>
                <button id="export-button" class="control-button clear" disabled>å¯¼å‡ºæ—¥å¿—</button>
            </div>
        </section>

        <section class="card">
            <div class="panel-header">
                <h2>å…¬å…±äº‹ä»¶æ—¥å¿—</h2>
            </div>
            <div id="event-log-content" class="log-box"></div>
        </section>

        <section class="card" id="god-panel">
            <div class="panel-header">
                <h2>å¯¹å±€æ¦‚è§ˆ</h2>
            </div>
            <div class="panel-grid" id="panel-players"></div>
            <div class="panel-summary">
                <div class="summary-item">
                    <span>é”¦æ ‡èµ›å±€æ•°</span>
                    <strong id="panel-hand-count">0</strong>
                </div>
                <div class="summary-item">
                    <span>å½“å‰åº•æ± </span>
                    <strong id="panel-current-pot">0</strong>
                </div>
                <div class="summary-item">
                    <span>ä½œå¼Šè­¦æˆ’å€¼</span>
                    <strong id="panel-alert-level" style="color: #4caf50;">0.0</strong>
                </div>
            </div>

        </section>

        <section class="card log-card">
            <div class="log-header">
                <span>ä¸Šå¸è§†è§’æ—¥å¿—</span>
                <span id="log-count">0 æ¡</span>
            </div>
            <div class="log-body">
                <aside class="inventory-panel">
                    <div class="inventory-title">å‚èµ›è€…èƒŒåŒ…</div>
                    <div id="inventory-container" class="inventory-list"></div>
                </aside>
                <div id="log-container"></div>
            </div>
        </section>
    </main>
</div>

<script>
    const statusDiv = document.getElementById("status");
    const logContainer = document.getElementById("log-container");
    const inventoryContainer = document.getElementById("inventory-container");
    const logCountSpan = document.getElementById("log-count");
    const startButton = document.getElementById("start-button");
    const stopButton = document.getElementById("stop-button");
    const clearButton = document.getElementById("clear-button");
    const exportButton = document.getElementById("export-button"); // <-- æ–°å¢
    let ws = null;
    let lastLogElement = null;
    let logCount = 0;

    function connect() {
        const wsProtocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${wsProtocol}//${window.location.host}/ws`;
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            statusDiv.textContent = "å·²è¿æ¥ (ä¸Šå¸æ¨¡å¼)";
            statusDiv.style.color = "var(--success)";
            setButtonState(false);
        };

        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            const isScrolledToBottom = logContainer.scrollHeight - logContainer.clientHeight <= logContainer.scrollTop + 10;

            if (msg.type === "log") {
                addLog(msg.message);
            } else if (msg.type === "stream_start") {
                addLog(msg.message, true);
                if (lastLogElement) {
                    lastLogElement.dataset.logType = "thinking";
                }
            } else if (msg.type === "stream_chunk") {
                if (lastLogElement) {
                    const cleanChunk = msg.chunk;
                    lastLogElement.textContent += cleanChunk;
                    if (isScrolledToBottom) {
                        logContainer.scrollTop = logContainer.scrollHeight;
                    }
                }
            } else if (msg.type === "panel_update") {
                updateGodPanel(msg.data);
            } else if (msg.type === "event_log_update") {
                updateEventLog(msg.data);
            } else if (msg.type === "status") {
                setButtonState(msg.running);
            }

            if ((msg.type === "log" || msg.type === "stream_start") && isScrolledToBottom) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        };

        ws.onclose = () => {
            statusDiv.textContent = "è¿æ¥å·²æ–­å¼€ã€‚5ç§’åé‡è¯•...";
            statusDiv.style.color = "var(--danger)";
            setButtonState(false, true);
            setTimeout(connect, 5000);
        };
        ws.onerror = () => {
            statusDiv.textContent = "è¿æ¥é”™è¯¯ã€‚";
            statusDiv.style.color = "var(--danger)";
            ws.close();
        };
    }

    function setButtonState(isRunning, isConnecting = false) {
        if (isConnecting) {
            startButton.disabled = true;
            stopButton.disabled = true;
            clearButton.disabled = true;
            exportButton.disabled = true; // <-- æ–°å¢
            startButton.textContent = "è¿æ¥ä¸­...";
        } else if (isRunning) {
            startButton.disabled = true;
            stopButton.disabled = false;
            clearButton.disabled = true;
            exportButton.disabled = true; // <-- æ–°å¢
            startButton.textContent = "æ¸¸æˆè¿è¡Œä¸­...";
        } else {
            startButton.disabled = false;
            stopButton.disabled = true;
            clearButton.disabled = false;
            exportButton.disabled = false; // <-- (ä¿®æ”¹) æ¸¸æˆåœæ­¢æ—¶ï¼Œå¯ç”¨å¯¼å‡º
            startButton.textContent = "å¼€å§‹æ¸¸æˆ";
        }
    }

    startButton.onclick = () => {
        if (ws && ws.readyState === WebSocket.OPEN) {
            const initialChipsEl = document.getElementById("input-initial-chips");
            const desperationThresholdEl = document.getElementById("input-desperation-threshold");
            const initialChips = parseInt(initialChipsEl?.value ?? "2000", 10);
            const desperationThreshold = parseInt(desperationThresholdEl?.value ?? "1000", 10);
            const payload = {
                type: "START_GAME",
                config: {
                    initial_chips: Number.isFinite(initialChips) && initialChips > 0 ? initialChips : 2000,
                    desperation_threshold: Number.isFinite(desperationThreshold) && desperationThreshold > 0 ? desperationThreshold : 1000,
                }
            };
            ws.send(JSON.stringify(payload));
        }
    };

    stopButton.onclick = () => {
        if (ws && ws.readyState === WebSocket.OPEN) {
            if (confirm("ç¡®å®šè¦ç«‹å³åœæ­¢å½“å‰é”¦æ ‡èµ›å—ï¼Ÿ")) {
                ws.send(JSON.stringify({type: "STOP_GAME"}));
            }
        }
    };

    clearButton.onclick = () => {
        logContainer.innerHTML = "";
        logCount = 0;
        updateLogCount();
    };

    // (â†“â†“ æ–°å¢è¿™ä¸ªå¤„ç†å™¨ â†“â†“)
    exportButton.onclick = () => {
        // è§¦å‘æµè§ˆå™¨ä¸‹è½½
        window.open("/download_latest_log", "_blank");
    };

    function updateLogCount() {
        logCountSpan.textContent = `${logCount} æ¡`;
    }

    function updateGodPanel(data) {
        document.getElementById("panel-hand-count").textContent = data.hand_count ?? 0;
        const potReal = (data.current_pot_real ?? data.current_pot ?? 0);
        const potDisplay = (data.current_pot_display ?? potReal);
        const potEl = document.getElementById("panel-current-pot");
        if (potEl) {
            potEl.textContent = `ä¼ª:${potDisplay} / çœŸ:${potReal}`;
        }

        // --- [ä¿®å¤ 5.7]ï¼šæ›´æ–°è­¦æˆ’å€¼ ---
        const alertLevelEl = document.getElementById("panel-alert-level");
        if (alertLevelEl) {
            const alertLevel = data.global_alert_level ?? 0;
            alertLevelEl.textContent = alertLevel.toFixed(1);
            // (æ–°) åŠ¨æ€å˜è‰²
            if (alertLevel >= 100) {
                alertLevelEl.style.color = "var(--danger)";
            } else if (alertLevel > 50) {
                alertLevelEl.style.color = "rgba(255, 193, 7, 0.9)"; // é»„è‰²
            } else {
                alertLevelEl.style.color = "var(--success)"; // ç»¿è‰²
            }
        }
        // --- [ä¿®å¤ 5.7 ç»“æŸ] ---

        const playersDiv = document.getElementById("panel-players");
        playersDiv.innerHTML = "";

        const players = data.players || [];
        // ğŸ“Œ æ–°å¢ï¼šè·å–å½“å‰å›åˆç©å®¶ ID
        const currentPlayerId = data.current_player;

        players.forEach(player => {
            const card = document.createElement("div");
            card.className = "player-card";
            if (player.chips <= 0) {
                card.classList.add("eliminated");
            }
            if (!player.is_active) {
                card.classList.add("folded");
            }
            if (player.is_active) {
                card.classList.add("active");
            }

            // ğŸ“Œ æ–°å¢ï¼šå¦‚æœç©å®¶ ID åŒ¹é…å½“å‰å›åˆ IDï¼Œåˆ™æ·»åŠ é«˜äº®ç±»
            if (player.id === currentPlayerId) {
                card.classList.add("is-current-turn");
            }


            const nameRow = document.createElement("div");
            nameRow.className = "player-name";
            const nameSpan = document.createElement("span");
            nameSpan.textContent = `${player.name} (P${player.id})`;
            nameRow.appendChild(nameSpan);
            if (player.is_dealer) {
                const dealer = document.createElement("span");
                dealer.className = "dealer-badge";
                dealer.textContent = "åº„";
                nameRow.appendChild(dealer);
            }

            const metaRow = document.createElement("div");
            metaRow.className = "player-meta";
            const chipsSpan = document.createElement("span");
            chipsSpan.className = "player-chips";
            chipsSpan.textContent = `ç­¹ç (çœŸ)ï¼š${player.actual_chips ?? player.chips}`;
            metaRow.appendChild(chipsSpan);

            if (player.counterfeit_display_chips != null) {
                const fakeSpan = document.createElement("span");
                fakeSpan.className = "player-chips-fake";
                fakeSpan.style.marginLeft = "8px";
                fakeSpan.textContent = `ç­¹ç (ä¼ª)ï¼š${player.counterfeit_display_chips}`;
                metaRow.appendChild(fakeSpan);
            }

            const statusTag = document.createElement("span");
            statusTag.className = `player-tag ${player.looked ? "looked" : "hidden"}`;
            statusTag.textContent = player.looked ? "å·²çœ‹ç‰Œ" : "æœªçœ‹ç‰Œ";
            metaRow.appendChild(statusTag);

            const expValue = Number(player.experience_value ?? 0);

            const handRow = document.createElement("div");
            handRow.className = "player-hand";
            handRow.textContent = player.hand_str || "...";

            const experienceRow = document.createElement("div");
            experienceRow.className = "player-experience-row";
            const expText = document.createElement("span");
            expText.className = "player-experience-text";
            expText.textContent = `ç»éªŒï¼š${player.experience_level} (${expValue.toFixed(1)})`;
            const expBar = document.createElement("div");
            expBar.className = "experience-bar";
            const expBarFill = document.createElement("div");
            expBarFill.className = "experience-bar-fill";
            const expRatio = Math.max(0, Math.min(1, expValue / 130));
            expBarFill.style.width = `${(expRatio * 100).toFixed(1)}%`;
            expBar.appendChild(expBarFill);
            experienceRow.appendChild(expText);
            experienceRow.appendChild(expBar);

            const pressureRow = document.createElement("div");
            pressureRow.className = "player-pressure";
            pressureRow.textContent = `å¿ƒç†ï¼š${player.pressure_state || "æœªçŸ¥"}`;

            card.appendChild(nameRow);
            card.appendChild(metaRow);
            card.appendChild(handRow);
            card.appendChild(experienceRow);
            card.appendChild(pressureRow);

            playersDiv.appendChild(card);
        });

        renderInventory(players);
    }

    function renderInventory(players = []) {
        if (!inventoryContainer) return;
        inventoryContainer.innerHTML = "";

        players.forEach(player => {
            const block = document.createElement("div");
            block.className = "inventory-player";

            const header = document.createElement("div");
            header.className = "inventory-player-header";
            header.textContent = player.name;

            const count = document.createElement("span");
            count.className = "inventory-count";
            count.textContent = `x${player.inventory_count || 0}`;
            header.appendChild(count);

            block.appendChild(header);

            const items = Array.isArray(player.inventory) ? player.inventory : [];
            if (items.length === 0) {
                const empty = document.createElement("p");
                empty.className = "inventory-empty";
                empty.textContent = "æš‚æ— é“å…·";
                block.appendChild(empty);
            } else {
                const list = document.createElement("ul");
                list.className = "inventory-items";
                items.forEach(item => {
                    const li = document.createElement("li");
                    li.className = "inventory-item";
                    li.textContent = item;
                    list.appendChild(li);
                });
                block.appendChild(list);
            }

            inventoryContainer.appendChild(block);
        });
    }

    function updateEventLog(log) {
        const logContent = document.getElementById("event-log-content");
        logContent.innerHTML = ""; // Clear existing log
        log.forEach(entry => {
            const p = document.createElement("p");
            p.textContent = JSON.stringify(entry);
            logContent.appendChild(p);
        });
        logContent.scrollTop = logContent.scrollHeight;
    }

    function addLog(message, isStreaming = false) {
        const p = document.createElement("p");
        p.className = "log-message";
        p.textContent = message;

        if (message.includes("--- ç¬¬") && message.includes("æ‰‹ç‰Œå¼€å§‹")) {
            p.dataset.logType = "round-start";
        } else if (message.includes("--- è½®åˆ°")) {
            p.dataset.logType = "turn";
        } else if (message.includes(" åŠ¨ä½œ]:")) {
            p.dataset.logType = "action";
        } else if (message.includes("èµ¢å®¶æ˜¯") || message.includes("--- æœ¬æ‰‹ç»“æŸ ---")) {
            p.dataset.logType = "result";
        }
        logContainer.appendChild(p);
        logCount += 1;
        updateLogCount();

        if (!isStreaming) {
            lastLogElement = null;
        } else {
            lastLogElement = p;
        }
    }

    connect();
</script>
</body>
</html>
