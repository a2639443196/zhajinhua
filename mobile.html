<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LLM 锦标赛 - 移动观战</title>
    <style>
        :root {
            color-scheme: dark;
            --bg-color: #0d0d0f;
            --card-color: rgba(32, 32, 40, 0.92);
            --accent: #4cafef;
            --accent-strong: #00e5ff;
            --danger: #ff5370;
            --success: #4caf50;
            --text-primary: #f5f5f5;
            --text-secondary: #c8c8d0;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "PingFang SC", "Helvetica Neue", Arial, sans-serif;
            background: radial-gradient(circle at top, rgba(30, 30, 40, 0.8), var(--bg-color));
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        header {
            padding: 18px 16px 8px;
            text-align: center;
        }

        header h1 {
            margin: 0;
            font-size: clamp(1.35rem, 4vw, 1.8rem);
            font-weight: 600;
            letter-spacing: 0.05em;
        }

        header p {
            margin: 6px 0 0;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        main {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 0 12px 24px;
            max-width: 620px;
            margin: 0 auto;
        }

        .card {
            background: var(--card-color);
            backdrop-filter: blur(12px);
            border-radius: 18px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.35);
        }

        .status-card {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .status-label {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .status-value {
            font-size: 1.15rem;
            font-weight: 600;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 10px;
        }

        button.control-button {
            appearance: none;
            border: none;
            border-radius: 12px;
            padding: 12px 10px;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            background: linear-gradient(145deg, rgba(76, 175, 239, 0.85), rgba(0, 149, 218, 0.78));
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.35);
            touch-action: manipulation;
        }

        button.control-button:active:not(:disabled) {
            transform: scale(0.97);
        }

        button.control-button:disabled {
            opacity: 0.45;
            box-shadow: none;
        }

        button.control-button.stop {
            background: linear-gradient(145deg, rgba(255, 83, 112, 0.9), rgba(255, 105, 135, 0.8));
        }

        button.control-button.clear {
            background: linear-gradient(145deg, rgba(123, 97, 255, 0.9), rgba(166, 95, 255, 0.8));
        }

        .panel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .panel-summary {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }

        .summary-item {
            background: rgba(255, 255, 255, 0.04);
            border-radius: 14px;
            padding: 10px 12px;
            text-align: center;
        }

        .summary-item span {
            display: block;
            font-size: 0.75rem;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
        }

        .summary-item strong {
            display: block;
            margin-top: 4px;
            font-size: 1.15rem;
        }

        .player-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 14px;
            padding: 12px;
            display: grid;
            gap: 6px;
            position: relative;
            border: 1px solid transparent;
        }

        .player-card.active {
            border-color: rgba(0, 229, 255, 0.35);
            box-shadow: 0 0 0 1px rgba(0, 229, 255, 0.12);
        }

        .player-name {
            font-weight: 600;
            font-size: 1.05rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dealer-badge {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 999px;
            background: rgba(255, 193, 7, 0.9);
            color: #1a1a1a;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .player-chips {
            font-size: 0.95rem;
            color: var(--accent);
        }

        .player-hand {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 0.04em;
        }

        .player-status {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .player-card.eliminated {
            opacity: 0.55;
            text-decoration: line-through;
        }

        .player-card.folded .player-hand {
            color: var(--danger);
        }

        .log-card {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        #log-container {
            min-height: 42vh;
            max-height: 55vh;
            overflow-y: auto;
            padding-right: 4px;
        }

        .log-message {
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 0.95rem;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .log-message:last-child {
            margin-bottom: 0;
        }

        .log-message[data-log-type="round-start"] {
            border-left: 3px solid var(--success);
        }

        .log-message[data-log-type="result"] {
            border-left: 3px solid var(--danger);
        }

        .log-message[data-log-type="thinking"] {
            border-left: 3px solid var(--accent-strong);
        }

        footer {
            text-align: center;
            padding: 12px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.4);
        }

        @media (max-width: 360px) {
            .controls {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            button.control-button:last-child {
                grid-column: span 2;
            }
        }
    </style>
</head>
<body>
<header>
    <h1>LLM 锦标赛·移动观战</h1>
    <p>实时查看筹码、动作与上帝视角日志</p>
</header>
<main>
    <section class="card status-card">
        <div>
            <div class="status-label">当前连接状态</div>
            <div class="status-value" id="status">正在连接到服务器...</div>
        </div>
        <div class="controls">
            <button id="start-button" class="control-button">连接中...</button>
            <button id="stop-button" class="control-button stop" disabled>停止</button>
            <button id="clear-button" class="control-button clear" disabled>清空日志</button>
        </div>
    </section>

    <section class="card">
        <div class="panel-summary">
            <div class="summary-item">
                <span>锦标赛局数</span>
                <strong id="panel-hand-count">0</strong>
            </div>
            <div class="summary-item">
                <span>当前底池</span>
                <strong id="panel-current-pot">0</strong>
            </div>
        </div>
        <div class="panel-grid" id="panel-players"></div>
    </section>

    <section class="card log-card">
        <div class="log-header">
            <span>上帝视角日志</span>
            <span id="log-count">0 条</span>
        </div>
        <div id="log-container"></div>
    </section>
</main>
<footer>为移动端定制的 LLM 锦标赛观战界面</footer>

<script>
    const statusDiv = document.getElementById("status");
    const logContainer = document.getElementById("log-container");
    const logCountSpan = document.getElementById("log-count");
    const startButton = document.getElementById("start-button");
    const stopButton = document.getElementById("stop-button");
    const clearButton = document.getElementById("clear-button");

    let ws = null;
    let lastLogElement = null;
    let logCount = 0;

    function connect() {
        const wsProtocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${wsProtocol}//${window.location.host}/ws`;
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            statusDiv.textContent = "已连接 (上帝模式)";
            statusDiv.style.color = "var(--success)";
            setButtonState(false);
        };

        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            const isScrolledToBottom = logContainer.scrollHeight - logContainer.clientHeight <= logContainer.scrollTop + 10;

            if (msg.type === "log") {
                addLog(msg.message);
            } else if (msg.type === "stream_start") {
                addLog(msg.message, true);
                if (lastLogElement) {
                    lastLogElement.dataset.logType = "thinking";
                }
            } else if (msg.type === "stream_chunk") {
                if (lastLogElement) {
                    lastLogElement.textContent += msg.chunk;
                    if (isScrolledToBottom) {
                        logContainer.scrollTop = logContainer.scrollHeight;
                    }
                }
            } else if (msg.type === "panel_update") {
                updateGodPanel(msg.data);
            } else if (msg.type === "status") {
                setButtonState(msg.running);
            }

            if ((msg.type === "log" || msg.type === "stream_start") && isScrolledToBottom) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        };

        ws.onclose = () => {
            statusDiv.textContent = "连接已断开，5秒后重试...";
            statusDiv.style.color = "var(--danger)";
            setButtonState(false, true);
            setTimeout(connect, 5000);
        };

        ws.onerror = () => {
            statusDiv.textContent = "连接错误";
            statusDiv.style.color = "var(--danger)";
            ws.close();
        };
    }

    function setButtonState(isRunning, isConnecting = false) {
        if (isConnecting) {
            startButton.disabled = true;
            stopButton.disabled = true;
            clearButton.disabled = true;
            startButton.textContent = "连接中...";
        } else if (isRunning) {
            startButton.disabled = true;
            stopButton.disabled = false;
            clearButton.disabled = true;
            startButton.textContent = "游戏运行中";
        } else {
            startButton.disabled = false;
            stopButton.disabled = true;
            clearButton.disabled = false;
            startButton.textContent = "开始游戏";
        }
    }

    startButton.onclick = () => {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: "START_GAME" }));
        }
    };

    stopButton.onclick = () => {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: "STOP_GAME" }));
        }
    };

    clearButton.onclick = () => {
        logContainer.innerHTML = "";
        logCount = 0;
        updateLogCount();
    };

    function addLog(text, isStreamStart = false) {
        const logEl = document.createElement("div");
        logEl.className = "log-message";
        logEl.textContent = text;
        if (text.includes("第") && text.includes("手牌")) {
            logEl.dataset.logType = "round-start";
        }
        if (text.includes("赢家") || text.includes("胜利")) {
            logEl.dataset.logType = "result";
        }
        logContainer.appendChild(logEl);
        lastLogElement = logEl;
        logCount += 1;
        updateLogCount();
    }

    function updateLogCount() {
        logCountSpan.textContent = `${logCount} 条`;
    }

    function updateGodPanel(data) {
        const handCountSpan = document.getElementById("panel-hand-count");
        const potSpan = document.getElementById("panel-current-pot");
        const playersContainer = document.getElementById("panel-players");

        handCountSpan.textContent = data.hand_count ?? 0;
        potSpan.textContent = data.current_pot ?? 0;

        playersContainer.innerHTML = "";

        (data.players || []).forEach(player => {
            const card = document.createElement("div");
            card.className = "player-card";
            if (!player.is_active) {
                card.classList.add("folded");
            }
            if (player.chips <= 0) {
                card.classList.add("eliminated");
            }
            if (player.is_active) {
                card.classList.add("active");
            }

            const nameRow = document.createElement("div");
            nameRow.className = "player-name";
            nameRow.textContent = player.name;
            if (player.is_dealer) {
                const dealer = document.createElement("span");
                dealer.className = "dealer-badge";
                dealer.textContent = "庄";
                nameRow.appendChild(dealer);
            }

            const chipsRow = document.createElement("div");
            chipsRow.className = "player-chips";
            chipsRow.textContent = `筹码：${player.chips}`;

            const handRow = document.createElement("div");
            handRow.className = "player-hand";
            handRow.textContent = player.hand_str || "...";

            const statusRow = document.createElement("div");
            statusRow.className = "player-status";
            statusRow.textContent = player.looked ? "状态：已看牌" : "状态：未看牌";

            card.appendChild(nameRow);
            card.appendChild(chipsRow);
            card.appendChild(handRow);
            card.appendChild(statusRow);

            playersContainer.appendChild(card);
        });
    }

    connect();
</script>
</body>
</html>
